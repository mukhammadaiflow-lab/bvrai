---
# External Secrets Operator - AWS Secrets Manager
# Note: Actual secrets should be stored in AWS Secrets Manager, HashiCorp Vault, etc.
# This uses the External Secrets Operator to sync them to Kubernetes

apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: builder-engine
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-west-2
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
---
# Database Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-secrets
  namespace: builder-engine
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: database-secrets
    creationPolicy: Owner
  data:
    - secretKey: POSTGRES_USER
      remoteRef:
        key: builder-engine/database
        property: username
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: builder-engine/database
        property: password
    - secretKey: DATABASE_URL
      remoteRef:
        key: builder-engine/database
        property: url
---
# Redis Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-secrets
  namespace: builder-engine
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: redis-secrets
    creationPolicy: Owner
  data:
    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: builder-engine/redis
        property: password
    - secretKey: REDIS_URL
      remoteRef:
        key: builder-engine/redis
        property: url
---
# API Keys and External Services
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: api-secrets
  namespace: builder-engine
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: api-secrets
    creationPolicy: Owner
  data:
    # OpenAI
    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: builder-engine/openai
        property: api_key
    # Anthropic
    - secretKey: ANTHROPIC_API_KEY
      remoteRef:
        key: builder-engine/anthropic
        property: api_key
    # ElevenLabs
    - secretKey: ELEVENLABS_API_KEY
      remoteRef:
        key: builder-engine/elevenlabs
        property: api_key
    # Deepgram
    - secretKey: DEEPGRAM_API_KEY
      remoteRef:
        key: builder-engine/deepgram
        property: api_key
    # Twilio
    - secretKey: TWILIO_ACCOUNT_SID
      remoteRef:
        key: builder-engine/twilio
        property: account_sid
    - secretKey: TWILIO_AUTH_TOKEN
      remoteRef:
        key: builder-engine/twilio
        property: auth_token
    # Stripe
    - secretKey: STRIPE_SECRET_KEY
      remoteRef:
        key: builder-engine/stripe
        property: secret_key
    - secretKey: STRIPE_WEBHOOK_SECRET
      remoteRef:
        key: builder-engine/stripe
        property: webhook_secret
---
# JWT Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: jwt-secrets
  namespace: builder-engine
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: jwt-secrets
    creationPolicy: Owner
  data:
    - secretKey: JWT_SECRET_KEY
      remoteRef:
        key: builder-engine/jwt
        property: secret_key
    - secretKey: JWT_REFRESH_SECRET_KEY
      remoteRef:
        key: builder-engine/jwt
        property: refresh_secret_key
---
# RabbitMQ Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: rabbitmq-secrets
  namespace: builder-engine
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: rabbitmq-secrets
    creationPolicy: Owner
  data:
    - secretKey: RABBITMQ_USER
      remoteRef:
        key: builder-engine/rabbitmq
        property: username
    - secretKey: RABBITMQ_PASSWORD
      remoteRef:
        key: builder-engine/rabbitmq
        property: password
---
# MinIO/S3 Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: storage-secrets
  namespace: builder-engine
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: storage-secrets
    creationPolicy: Owner
  data:
    - secretKey: AWS_ACCESS_KEY_ID
      remoteRef:
        key: builder-engine/s3
        property: access_key
    - secretKey: AWS_SECRET_ACCESS_KEY
      remoteRef:
        key: builder-engine/s3
        property: secret_key
