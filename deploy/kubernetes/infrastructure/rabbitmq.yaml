---
# RabbitMQ Cluster for Builder Engine
# Used for async task queues, event distribution, and worker communication
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rabbitmq
  namespace: builder-engine
  labels:
    app: rabbitmq
    tier: messaging
spec:
  serviceName: rabbitmq-headless
  replicas: 3
  selector:
    matchLabels:
      app: rabbitmq
  template:
    metadata:
      labels:
        app: rabbitmq
        tier: messaging
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "15692"
    spec:
      serviceAccountName: rabbitmq-sa
      terminationGracePeriodSeconds: 120
      securityContext:
        runAsUser: 999
        runAsGroup: 999
        fsGroup: 999
      initContainers:
        - name: copy-config
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              cp /config/rabbitmq.conf /etc/rabbitmq/rabbitmq.conf
              cp /config/enabled_plugins /etc/rabbitmq/enabled_plugins
          volumeMounts:
            - name: config
              mountPath: /config
            - name: rabbitmq-config
              mountPath: /etc/rabbitmq
      containers:
        - name: rabbitmq
          image: rabbitmq:3.12-management-alpine
          imagePullPolicy: IfNotPresent
          ports:
            - name: amqp
              containerPort: 5672
              protocol: TCP
            - name: management
              containerPort: 15672
              protocol: TCP
            - name: prometheus
              containerPort: 15692
              protocol: TCP
            - name: epmd
              containerPort: 4369
              protocol: TCP
            - name: dist
              containerPort: 25672
              protocol: TCP
          env:
            - name: MY_POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: MY_POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: RABBITMQ_USE_LONGNAME
              value: "true"
            - name: K8S_SERVICE_NAME
              value: rabbitmq-headless
            - name: RABBITMQ_NODENAME
              value: rabbit@$(MY_POD_NAME).$(K8S_SERVICE_NAME).$(MY_POD_NAMESPACE).svc.cluster.local
            - name: K8S_HOSTNAME_SUFFIX
              value: .$(K8S_SERVICE_NAME).$(MY_POD_NAMESPACE).svc.cluster.local
            - name: RABBITMQ_DEFAULT_USER
              valueFrom:
                secretKeyRef:
                  name: rabbitmq-secrets
                  key: RABBITMQ_USER
            - name: RABBITMQ_DEFAULT_PASS
              valueFrom:
                secretKeyRef:
                  name: rabbitmq-secrets
                  key: RABBITMQ_PASSWORD
            - name: RABBITMQ_ERLANG_COOKIE
              valueFrom:
                secretKeyRef:
                  name: rabbitmq-secrets
                  key: RABBITMQ_ERLANG_COOKIE
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 4Gi
          livenessProbe:
            exec:
              command:
                - rabbitmq-diagnostics
                - -q
                - ping
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          readinessProbe:
            exec:
              command:
                - rabbitmq-diagnostics
                - -q
                - check_running
            initialDelaySeconds: 20
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          volumeMounts:
            - name: data
              mountPath: /var/lib/rabbitmq/mnesia
            - name: rabbitmq-config
              mountPath: /etc/rabbitmq
          lifecycle:
            postStart:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - |
                    until rabbitmqctl await_startup; do sleep 2; done
                    # Set up cluster on first boot
                    if [ "$(hostname)" != "rabbitmq-0" ]; then
                      rabbitmqctl stop_app || true
                      rabbitmqctl reset || true
                      rabbitmqctl join_cluster rabbit@rabbitmq-0.rabbitmq-headless.builder-engine.svc.cluster.local || true
                      rabbitmqctl start_app || true
                    fi
            preStop:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - |
                    rabbitmqctl stop_app
      volumes:
        - name: config
          configMap:
            name: rabbitmq-config
        - name: rabbitmq-config
          emptyDir: {}
  volumeClaimTemplates:
    - metadata:
        name: data
        labels:
          app: rabbitmq
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: gp3-encrypted
        resources:
          requests:
            storage: 50Gi
---
# Headless service for StatefulSet DNS
apiVersion: v1
kind: Service
metadata:
  name: rabbitmq-headless
  namespace: builder-engine
  labels:
    app: rabbitmq
spec:
  type: ClusterIP
  clusterIP: None
  selector:
    app: rabbitmq
  ports:
    - name: amqp
      port: 5672
      targetPort: 5672
    - name: epmd
      port: 4369
      targetPort: 4369
    - name: dist
      port: 25672
      targetPort: 25672
---
# Main RabbitMQ Service
apiVersion: v1
kind: Service
metadata:
  name: rabbitmq
  namespace: builder-engine
  labels:
    app: rabbitmq
spec:
  type: ClusterIP
  selector:
    app: rabbitmq
  ports:
    - name: amqp
      port: 5672
      targetPort: 5672
    - name: management
      port: 15672
      targetPort: 15672
    - name: prometheus
      port: 15692
      targetPort: 15692
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rabbitmq-config
  namespace: builder-engine
data:
  rabbitmq.conf: |
    ## Cluster formation. See https://www.rabbitmq.com/cluster-formation.html
    cluster_formation.peer_discovery_backend = rabbit_peer_discovery_k8s
    cluster_formation.k8s.host = kubernetes.default.svc.cluster.local
    cluster_formation.k8s.address_type = hostname
    cluster_formation.k8s.service_name = rabbitmq-headless
    cluster_formation.k8s.hostname_suffix = .rabbitmq-headless.builder-engine.svc.cluster.local
    cluster_formation.node_cleanup.interval = 30
    cluster_formation.node_cleanup.only_log_warning = true
    cluster_partition_handling = autoheal

    ## Queue leader locator
    queue_leader_locator = min-masters

    ## Memory management
    vm_memory_high_watermark.relative = 0.6
    vm_memory_high_watermark_paging_ratio = 0.5

    ## Disk free space
    disk_free_limit.absolute = 2GB

    ## Logging
    log.file.level = info
    log.console.level = info

    ## Default user
    default_user = guest
    default_pass = guest
    default_vhost = /

    ## Networking
    listeners.tcp.default = 5672

    ## Management
    management.tcp.port = 15672
    management.cors.allow_origins.1 = *
    management.cors.max_age = 3600

    ## Prometheus metrics
    prometheus.return_per_object_metrics = true
    prometheus.tcp.port = 15692

    ## Connection limits
    channel_max = 2047
    heartbeat = 60

    ## Message store
    queue_index_embed_msgs_below = 4096

    ## HA policy (applied via definitions)
    ## Use quorum queues for durability

  enabled_plugins: |
    [rabbitmq_management,rabbitmq_peer_discovery_k8s,rabbitmq_prometheus,rabbitmq_shovel,rabbitmq_shovel_management].

  definitions.json: |
    {
      "vhosts": [
        {"name": "/"},
        {"name": "builderengine"}
      ],
      "permissions": [
        {
          "user": "admin",
          "vhost": "builderengine",
          "configure": ".*",
          "write": ".*",
          "read": ".*"
        }
      ],
      "exchanges": [
        {
          "name": "calls",
          "vhost": "builderengine",
          "type": "topic",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "events",
          "vhost": "builderengine",
          "type": "fanout",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "workers",
          "vhost": "builderengine",
          "type": "direct",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "dlx",
          "vhost": "builderengine",
          "type": "fanout",
          "durable": true,
          "auto_delete": false
        }
      ],
      "queues": [
        {
          "name": "call.processing",
          "vhost": "builderengine",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-queue-type": "quorum",
            "x-dead-letter-exchange": "dlx"
          }
        },
        {
          "name": "transcription.processing",
          "vhost": "builderengine",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-queue-type": "quorum",
            "x-dead-letter-exchange": "dlx"
          }
        },
        {
          "name": "analytics.processing",
          "vhost": "builderengine",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-queue-type": "quorum",
            "x-dead-letter-exchange": "dlx"
          }
        },
        {
          "name": "workflow.processing",
          "vhost": "builderengine",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-queue-type": "quorum",
            "x-dead-letter-exchange": "dlx"
          }
        },
        {
          "name": "webhook.delivery",
          "vhost": "builderengine",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-queue-type": "quorum",
            "x-dead-letter-exchange": "dlx",
            "x-message-ttl": 86400000
          }
        },
        {
          "name": "billing.events",
          "vhost": "builderengine",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-queue-type": "quorum"
          }
        },
        {
          "name": "dlq",
          "vhost": "builderengine",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-queue-type": "quorum"
          }
        }
      ],
      "bindings": [
        {
          "source": "workers",
          "vhost": "builderengine",
          "destination": "call.processing",
          "destination_type": "queue",
          "routing_key": "call"
        },
        {
          "source": "workers",
          "vhost": "builderengine",
          "destination": "transcription.processing",
          "destination_type": "queue",
          "routing_key": "transcription"
        },
        {
          "source": "workers",
          "vhost": "builderengine",
          "destination": "analytics.processing",
          "destination_type": "queue",
          "routing_key": "analytics"
        },
        {
          "source": "workers",
          "vhost": "builderengine",
          "destination": "workflow.processing",
          "destination_type": "queue",
          "routing_key": "workflow"
        },
        {
          "source": "workers",
          "vhost": "builderengine",
          "destination": "webhook.delivery",
          "destination_type": "queue",
          "routing_key": "webhook"
        },
        {
          "source": "workers",
          "vhost": "builderengine",
          "destination": "billing.events",
          "destination_type": "queue",
          "routing_key": "billing"
        },
        {
          "source": "dlx",
          "vhost": "builderengine",
          "destination": "dlq",
          "destination_type": "queue",
          "routing_key": ""
        }
      ],
      "policies": [
        {
          "vhost": "builderengine",
          "name": "ha-all",
          "pattern": ".*",
          "definition": {
            "ha-mode": "all",
            "ha-sync-mode": "automatic"
          }
        }
      ]
    }
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: rabbitmq-sa
  namespace: builder-engine
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: rabbitmq-peer-discovery
  namespace: builder-engine
rules:
  - apiGroups: [""]
    resources: ["endpoints"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: rabbitmq-peer-discovery
  namespace: builder-engine
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: rabbitmq-peer-discovery
subjects:
  - kind: ServiceAccount
    name: rabbitmq-sa
    namespace: builder-engine
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: rabbitmq-pdb
  namespace: builder-engine
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: rabbitmq
